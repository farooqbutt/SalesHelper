@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> _signInManager
@model SalesHelper.Models.InterfaceModels.CountertopQuotationCreateInterface
@inject SalesHelper.Repository.CustomerRepo _customerService
@inject SalesHelper.Data.ApplicationDbContext context
@{
    var roomTypes = Enum.GetValues(typeof(CountertopQuotation.RoomTypes))
                                .Cast<CountertopQuotation.RoomTypes>()
                                .Select(e => e.GetEnumMemberAttributeValue())
                                .ToList();
    var edgeProfiles = Enum.GetValues(typeof(CountertopQuotation.EdgeProfiles))
                        .Cast<CountertopQuotation.EdgeProfiles>()
                        .Select(e => e.GetEnumMemberAttributeValue())
                        .ToList();
    var materials = Enum.GetValues(typeof(CountertopMaterial.Materials))
                        .Cast<CountertopMaterial.Materials>()
                        .Select(e => e.GetEnumMemberAttributeValue())
                        .ToList();

    var brands = context.CountertopBrandsData.Select(a => a.Brand).Distinct().ToList();

    // getting vendors for the current user with business type 2 (2 = "Stone and Countertops")
    var vendors = context.Vendor.Where(v => v.BusinessTypeId == 2 && v.AccountNumberId == _signInManager.UserManager.GetUserAsync(User).Result.AccountNumber).ToList();

    var customerId = Model.CountertopQuotation.CustomerId;
    var customersList = _customerService.ReadAll().Where(a => a.CreatedByUserId == _signInManager.UserManager.GetUserAsync(User).Result.Id);
}
<style>
    .select2-selection {
        border-radius: 0px !important;
    }

    .input-group > .select2-container--default {
        width: auto;
        flex: 1 1 auto;
    }

    .input-group > .select2-container--default .select2-selection--single {
        height: 100%;
        line-height: inherit
        padding: 0.5rem 1rem;
    }
</style>
<div class="content-wrapper">
    <div class="content-header row">
        <div class="content-header-left col-md-6 col-12 mb-2">
            <h3 class="content-header-title mb-0">Edit Countertop Quotation</h3>
        </div>
    </div>
    <div class="content-body">

        <div class="card">
            <div class="card-header">
                <h4 class="card-title text-primary">Countertop Quote Details</h4>
            </div>
            <div class="card-content collapse show">
                <div class="card-body">
                    <form class="form" id="CountertopQuotationForm">
                        <div class="form-body">

                            <div class="form-group">
                                <label>Customer Name <span class="required">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text square">
                                            <i class="feather icon-user"></i>
                                        </span>
                                    </div>
                                    <select class="form-control square" asp-for="CountertopQuotation.CustomerId" data-placeholder="Select a Customer" required></select>
                                    <div class="input-group-append">
                                        <a class="btn btn-primary" asp-controller="Customers" asp-action="AddCustomers" target="_blank">
                                            Add New Customer
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div class="hidden">
                                <input asp-for="CountertopQuotation.Id" />
                                <input asp-for="CountertopQuotation.CreatedDateTime" />
                                <input asp-for="CountertopQuotation.ModifiedDateTime" value="@DateTime.Now.ToString("yyyy-MM-ddThh:mm")" />
                                <input asp-for="CountertopQuotation.CreatedByUserId" />
                            </div>

                            <div class="form-group">
                                <label>Quote Name <span class="required">*</span></label>
                                <input class="form-control square" asp-for="CountertopQuotation.Name" placeholder="Quote Name" required />
                            </div>

                            <h4 class="form-section"><i class="feather icon-file-text"></i> Quote Details</h4>

                            <div class="form-group">
                                <label>Room Type</label>
                                <select class="form-control square" asp-for="CountertopQuotation.RoomType">
                                    <option selected disabled>Choose Room Type</option>
                                    @foreach (var item in roomTypes)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Edge Profile</label>
                                <select class="form-control square" asp-for="CountertopQuotation.EdgeProfile">
                                    <option selected disabled>Choose Edge Profile</option>
                                    @foreach (var item in edgeProfiles)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                </select>
                            </div>

                            <div class="row mb-1">
                                <div class="col-md-3">
                                    <fieldset>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" asp-for="CountertopQuotation.MiteredEdge" class="custom-control-input" id="MiteredEdge" />
                                            <label class="custom-control-label" for="MiteredEdge">Mitered Edge</label>
                                        </div>
                                    </fieldset>
                                    <fieldset>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" asp-for="CountertopQuotation.MiteredEdgeOnIsland" class="custom-control-input" id="MiteredEdgeOnIsland" />
                                            <label class="custom-control-label" for="MiteredEdgeOnIsland">Mitered Edge On Island</label>
                                        </div>
                                    </fieldset>
                                    <fieldset>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" asp-for="CountertopQuotation.WaterfallOnIsland" class="custom-control-input" id="WaterfallOnIsland" />
                                            <label class="custom-control-label" for="WaterfallOnIsland">Walterfall On Island</label>
                                        </div>
                                    </fieldset>
                                </div>
                                <div class="col-md-3">
                                    <fieldset>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" asp-for="CountertopQuotation.FarmhouseSink" class="custom-control-input" id="FarmhouseSink" />
                                            <label class="custom-control-label" for="FarmhouseSink">Farmhouse Sink</label>
                                        </div>
                                    </fieldset>
                                    <fieldset>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" asp-for="CountertopQuotation.IslandPrepSink" class="custom-control-input" id="IslandPrepSink" />
                                            <label class="custom-control-label" for="IslandPrepSink">Island Prep Sink</label>
                                        </div>
                                    </fieldset>
                                </div>

                                <div class="col-md-3">
                                    <fieldset>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" asp-for="CountertopQuotation.Cooktop" class="custom-control-input" id="Cooktop" />
                                            <label class="custom-control-label" for="Cooktop">Cooktop</label>
                                        </div>
                                    </fieldset>
                                    <fieldset>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" asp-for="CountertopQuotation.Rangetop" class="custom-control-input" id="Rangetop" />
                                            <label class="custom-control-label" for="Rangetop">Rangetop</label>
                                        </div>
                                    </fieldset>
                                </div>
                                <div class="col-md-3">
                                    <fieldset>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" asp-for="CountertopQuotation.FullBacksplash" class="custom-control-input" id="FullBacksplash" />
                                            <label class="custom-control-label" for="FullBacksplash">Full Backsplash</label>
                                        </div>
                                    </fieldset>
                                    <fieldset>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" asp-for="CountertopQuotation.FourIncBacksplash" class="custom-control-input" id="FourInchBacksplash" />
                                            <label class="custom-control-label" for="FourInchBacksplash">4" Backsplash</label>
                                        </div>
                                    </fieldset>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Estimate Square Feet</label>
                                <input class="form-control square" asp-for="CountertopQuotation.EstimateSquareFeet" placeholder="Estimate Square Feet" />
                            </div>

                            <div class="d-flex justify-content-between align-content-lg-end">
                                <h4 class="card-title text-primary">
                                    Material & Price
                                </h4>
                                <div class="form-group">
                                    <button type="button" class="btn btn-primary" id="btnAddMaterial">
                                        <i class="feather icon-plus"></i> Add New Material
                                    </button>
                                </div>
                            </div>
                            <div class="card-content collapse show">
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table" id="materialTable">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Material</th>
                                                    <th>Brand</th>
                                                    <th>Color</th>
                                                    <th>Vendor</th>
                                                    <th>Vendor Rate</th>
                                                    <th>Price Quote</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @* @foreach (var item in Model.CountertopMaterials)
                                                {
                                                    var index = Model.CountertopMaterials.IndexOf(item) + 1;
                                                    <tr>
                                                        <td><b class="item-number">@index</b></td>
                                                        <td>@item.Material</td>
                                                        <td>@item.Brand</td>
                                                        <td>@item.Color</td>
                                                        <td>@item.VendorIdFk.CompanyName</td>
                                                        <td>@item.VendorRate</td>
                                                        <td>@item.PriceQuote</td>
                                                        <td style="vertical-align:middle;">
                                                            <button class=" btn btn-sm btn-danger delete-row">
                                                                <i class="feather icon-trash" title="Delete Item"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                } *@
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="form-actions text-center">
                            <a asp-controller="Quotations" asp-action="QuotationsListView" class="width-150 btn btn-warning"><i class="feather icon-x"></i> Cancel</a>
                            <button type="submit" class="width-150 btn btn-primary"><i class="feather icon-save"></i> Update Quote</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>

<script>

    $(document).ready(function () {
        // For Customers Select List
        var customerList = @Html.Raw(Json.Serialize(customersList));
        $("#CountertopQuotation_CustomerId").select2({
            placeholder: $(this).data("placeholder"),
            width: $(this).data('width') ? $(this).data('width') : $(this).hasClass('w-100') ? '100%' : 'style',
            data: customerList.map(function (customer) {
                return {
                    id: customer.id,
                    text: customer.firstName + " " + customer.lastName
                };
            })
        });
        $("#CountertopQuotation_CustomerId").val(@customerId).trigger("change");

        PopulateMaterials();

        // Function to add row in table
        function PopulateMaterials() {
            var materialsData = @Html.Raw(Json.Serialize(Model.CountertopMaterials));
            materialsData.forEach(function (material) {
                var newRow = `
                            <tr>
                                <td><b class="item-number"></b></td>
                                <td>
                                    <select class="form-control square material-select" data-placeholder="Select Material">
                                        @foreach (var item in materials)
                                        {
                                            <option value="@item">@item</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <input type="search" list="brands" class="form-control square brand-select" placeholder="Brand" value="${material.brand}" />
                                    <datalist id="brands">
                                        @foreach (var item in brands)
                                        {
                                            <option value="@item" />
                                        }
                                    </datalist>
                                </td>
                                <td>
                                    <input type="search" list="colors_${material.id}" class="form-control square color-input" placeholder="Color" value="${material.color}" />
                                    <datalist id="colors_${material.id}" class="color-select">
                                    </datalist>
                                </td>
                                <td>
                                    <select class="form-control square vendor-select" data-placeholder="Select Vendor">
                                        @foreach (var item in vendors)
                                        {
                                            <option value="@item.VendorId">@item.CompanyName</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <input type="number" class="form-control square" placeholder="Vendor Rate" value="${material.vendorRate}" />
                                </td>
                                <td>
                                    <input type="number" class="form-control square" placeholder="Price Quote" value=${material.priceQuote} />
                                </td>
                                <td style="vertical-align:middle;">
                                    <span class="dropdown">
                                        <a id="btnActions" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" class="dropdown-toggle"><i class="feather icon-more-vertical"></i></a>
                                        <span aria-labelledby="btnActions" class="dropdown-menu mt-1">
                                            <button class="dropdown-item duplicate-row"><i class="feather icon-copy primary mr-1"></i>Duplicate</button>
                                            <a href="/Quotations/CountertopPriceInquiry?QuoteId=${material.countertopQuotationId}&VendorId=${material.vendorId}" 
                                               class="dropdown-item inquiry"><i class="feather icon-mail primary mr-1"></i>Price Inquiry</a>
                                            <button class="dropdown-item delete-row"><i class="feather icon-x danger mr-1"></i>Delete</button>
                                        </span>
                                    </span>
                                    
                                </td>
                            </tr>
                        `;

                $('#materialTable tbody').append(newRow);

                // convert newRow to HTML tr element
                var addedRow = $('#materialTable tbody tr:last-child');

                // get the brand select element from the added row
                var materialSelect = addedRow.find('.material-select');
                var brandSelect = addedRow.find('.brand-select');
                var colorSelect = addedRow.find('.color-select');
                var vendorSelect = addedRow.find('.vendor-select');

                materialSelect.select2({
                    placeholder: $(this).data("placeholder"),
                    width: "100%"
                });
                materialSelect.val(material.material).trigger('change');

                vendorSelect.select2({
                    placeholder: $(this).data("placeholder"),
                    width: "100%"
                });
                vendorSelect.val(material.vendorId).trigger('change');


                // Event listener for brand select change
                brandSelect.on('change', function () {
                    // empty the value of color input
                    addedRow.find('.color-input').val('');
                    var selectedBrand = $(this).val();
                    // Make AJAX request to fetch colors based on selected brand
                    $.ajax({
                        url: '/Quotations/GetColorsForBrand', // Replace with your endpoint to fetch colors
                        method: 'GET',
                        data: { brand: selectedBrand },
                        success: function (colors) {
                            // clear the color datalist first
                            colorSelect.empty();
                            // append the colors to the color datalist
                            colors.forEach(function (color) {
                                colorSelect.append(`<option value="${color}" />`);
                            });
                        },
                        error: function (xhr, status, error) {
                            alert(error);
                        }
                    });
                });

                // Update item numbers
                updateItemNumbers();
            });
        }

        // Submitting Countertop Quotation Form with Material List
        $("#CountertopQuotationForm").submit(function (e) {
            e.preventDefault();

            var countertopQuotationData = {};
            $(this).find("input, select").each(function () {
                if (this.type === "checkbox") {
                    if (this.checked) {
                        countertopQuotationData[this.name.split(".")[1]] = this.checked;
                    }
                } else if (this.type != "hidden") {
                    countertopQuotationData[this.name.split(".")[1]] = $(this).val();
                }
            });

            var data = {
                countertopQuotation: countertopQuotationData,
                countertopMaterials: GetMaterials()
            };

            $.ajax({
                url: "/Quotations/EditCountertopQuotation",
                type: "POST",
                data: {
                    quote: data
                },
                success: function (data) {
                    if (data.message == "success") {
                        toastr.success(data.result, "Success", { "progressBar": true });
                        setTimeout(function () {
                            window.location.href = "/Quotations/QuotationsListView";
                        }, 4000);
                    } else {
                        toastr.info(data.result, "Information", { "progressBar": true });
                    }
                },
                error: function (error) {
                    toastr.error(error, 'Error!', { "progressBar": true });
                }
            });
        });

        $('#btnAddMaterial').on('click', function () {
            addRow();
        });

        function GetMaterials() {
            var listOfMaterials = new Array();
            $("#materialTable").find("tr:gt(0)").each(function () {
                var material = $(this).find("td:eq(1)").find("select").val();
                var brand = $(this).find("td:eq(2)").find("input").val();
                var color = $(this).find("td:eq(3)").find("input").val();
                var vendorId = $(this).find("td:eq(4)").find("select").val();
                var vendorRate = $(this).find("td:eq(5)").find("input").val();
                var priceQuote = $(this).find("td:eq(6)").find("input").val();

                var CountertopMaterial = {};

                CountertopMaterial.material = material;
                CountertopMaterial.brand = brand;
                CountertopMaterial.color = color;
                CountertopMaterial.vendorId = vendorId;
                CountertopMaterial.vendorRate = vendorRate;
                CountertopMaterial.priceQuote = priceQuote;

                listOfMaterials.push(CountertopMaterial);
            });
            return listOfMaterials;
        }

        // initialing colorDatalistId for dynamic datalist id
        var colorDatalistId = 0;

        // Function to add row in table
        function addRow() {
            // increment colorDatalistId
            colorDatalistId++;
            var newRow = `
                        <tr>
                            <td><b class="item-number"></b></td>
                            <td>
                                <select class="form-control square material-select" data-placeholder="Select Material">
                                    @foreach (var item in materials)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                </select>
                            </td>
                            <td>
                                <input type="search" list="brands" class="form-control square brand-select" placeholder="Brand" />
                                <datalist id="brands">
                                    @foreach (var item in brands)
                                    {
                                        <option value="@item" />
                                    }
                                </datalist>
                            </td>
                            <td>
                                <input type="search" list="colors_${colorDatalistId}" class="form-control square color-input" placeholder="Color" />
                                <datalist id="colors_${colorDatalistId}" class="color-select">
                                </datalist>
                            </td>
                            <td>
                                <select class="form-control square vendor-select" data-placeholder="Select Vendor">
                                    @foreach (var item in vendors)
                                    {
                                        <option value="@item.VendorId">@item.CompanyName</option>
                                    }
                                </select>
                            </td>
                            <td>
                                <input type="number" class="form-control square" placeholder="Vendor Rate" />
                            </td>
                            <td>
                                <input type="number" class="form-control square" placeholder="Price Quote" />
                            </td>
                            <td style="vertical-align:middle;">
                                <button class="btn btn-sm btn-primary duplicate-row"><i class="feather icon-copy" title="Duplicate Item"></i></button>
                                <button class="btn btn-sm btn-danger delete-row"><i class="feather icon-trash" title="Delete Item"></i></button>
                            </td>
                        </tr>
                    `;

            $('#materialTable tbody').append(newRow);

            // convert newRow to HTML tr element
            var addedRow = $('#materialTable tbody tr:last-child');

            // get the brand select element from the added row
            var materialSelect = addedRow.find('.material-select');
            var brandSelect = addedRow.find('.brand-select');
            var colorSelect = addedRow.find('.color-select');
            var vendorSelect = addedRow.find('.vendor-select');

            materialSelect.select2({
                placeholder: $(this).data("placeholder"),
                width: "100%"
            });
            materialSelect.val(null).trigger('change');

            vendorSelect.select2({
                placeholder: $(this).data("placeholder"),
                width: "100%"
            });
            vendorSelect.val(null).trigger('change');


            // Event listener for brand select change
            brandSelect.on('change', function () {
                // empty the value of color input
                addedRow.find('.color-input').val('');
                var selectedBrand = $(this).val();
                // Make AJAX request to fetch colors based on selected brand
                $.ajax({
                    url: '/Quotations/GetColorsForBrand', // Replace with your endpoint to fetch colors
                    method: 'GET',
                    data: { brand: selectedBrand },
                    success: function (colors) {
                        // clear the color datalist first
                        colorSelect.empty();
                        // append the colors to the color datalist
                        colors.forEach(function (color) {
                            colorSelect.append(`<option value="${color}" />`);
                        });
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                    }
                });
            });

            // Update item numbers
            updateItemNumbers();
        }

        // Function to update item numbers
        function updateItemNumbers() {
            $('.item-number').each(function (index) {
                $(this).text(index + 1);
            });
        }

        // Remove row when the "Delete Item" button is clicked
        $('#materialTable').on('click', '.delete-row', function (event) {
            // prevent form submission
            event.preventDefault();
            $(this).closest('tr').remove();
            updateItemNumbers();
        });

        // Duplicate row when the "Duplicate Item" button is clicked
        $('#materialTable').on('click', '.duplicate-row', function (event) {
            // prevent form submission
            event.preventDefault();
            var rowToDuplicate = $(this).closest('tr');
            var clonedRow = rowToDuplicate.clone();

            updateColorDatalistId(clonedRow);

            rowToDuplicate.after(clonedRow);
            updateItemNumbers();
        });

        // update id of color datalist
        function updateColorDatalistId(clonedRow) {

            const itemNumberElement = clonedRow.find('.item-number');
            const newItemNumber = parseInt(itemNumberElement.text().replace('Item ', '')) + 1;

            const colorDatalist = clonedRow.find('.color-select');
            const colorInput = clonedRow.find('.color-input');
            colorDatalist.attr('id', `colors_${newItemNumber}`);
            colorInput.attr('list', `colors_${newItemNumber}`);

            const brandSelect = clonedRow.find('.brand-select');
            brandSelect.on('change', function () {
                // empty the value of color input
                colorInput.val('');
                const selectedBrand = $(this).val();
                // Make AJAX request to fetch colors based on selected brand
                $.ajax({
                    url: '/Quotations/GetColorsForBrand',
                    method: 'GET',
                    data: { brand: selectedBrand },
                    success: function (colors) {
                        // clear the color datalist first
                        colorDatalist.empty();
                        // append the colors to the color datalist
                        colors.forEach(function (color) {
                            colorDatalist.append(`<option value="${color}" />`);
                        });
                    },
                    error: function (xhr, status, error) {
                        alert(error);
                    }
                });
            });
        }
    });
</script>